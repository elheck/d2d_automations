# Performance Testing for Search Function

This document describes the performance testing suite for the `find_matching_cards` search function in the d2d_automations check_stock module.

## Overview

The performance tests are located in `tests/performance_tests.rs` and provide comprehensive testing of the search function's performance characteristics under various conditions.

## Test Categories

### 1. Inventory Size Scaling (`test_search_performance_with_varying_inventory_sizes`)

Tests how search performance scales with inventory size:
- Tests with inventories from 10 to 10,000 cards
- Measures execution time for consistent search operations
- Validates that performance scales roughly linearly (not exponentially)
- Provides performance regression detection

**Sample Output:**
```
Operation                                | Inventory Size |     Time (ms) |    Matches
-------------------------------------------------------------------------------------
Basic search for 'Lightning Bolt'        | Inventory:     10 | Time:     0.03ms | Matches:    1
Basic search for 'Lightning Bolt'        | Inventory:    100 | Time:     0.18ms | Matches:    4
Basic search for 'Lightning Bolt'        | Inventory:   1000 | Time:     1.69ms | Matches:    4
Basic search for 'Lightning Bolt'        | Inventory:  10000 | Time:     9.60ms | Matches:    4
```

### 2. Language Preference Testing (`test_search_performance_with_different_languages`)

Tests search performance with different language preferences:
- Tests searches with no language preference (any language)
- Tests searches with specific languages (English, German, French, Spanish, Italian)
- Ensures all language-specific searches complete within reasonable time bounds

### 3. Language-Only Mode Testing (`test_search_performance_with_language_only_mode`)

Compares performance between:
- `preferred_language_only = false` (searches all languages)
- `preferred_language_only = true` (searches only preferred language)

### 4. Edge Case Performance (`test_search_performance_edge_cases`)

Tests performance of unusual search scenarios:
- Searching for non-existent cards
- Searching with very large quantities
- Searching with empty strings
- Validates that edge cases don't cause performance degradation

### 5. Memory Usage Estimation (`test_search_performance_memory_usage`)

Provides estimates of memory usage for different inventory sizes:
- Calculates approximate memory footprint
- Tests search performance with large datasets
- Ensures memory usage scales appropriately

### 6. Concurrent Safety (`test_search_performance_concurrent_safety`)

Tests that multiple sequential searches:
- Don't interfere with each other
- Maintain consistent performance
- Don't cause state corruption

## Running Performance Tests

To run all performance tests with output:
```bash
cargo test test_search_performance -- --nocapture
```

To run specific performance test categories:
```bash
cargo test test_search_performance_with_varying_inventory_sizes -- --nocapture
cargo test test_search_performance_with_different_languages -- --nocapture
```

To run helper/validation tests:
```bash
cargo test benchmark_helpers -- --nocapture
```

## Performance Expectations

Based on current implementation:

- **Small inventories** (10-100 cards): < 1ms per search
- **Medium inventories** (1000 cards): 1-2ms per search  
- **Large inventories** (10000 cards): 5-15ms per search
- **Memory usage**: ~468 bytes per card in inventory

## Test Data Generation

The tests use synthetic data generated by `generate_test_inventory()`:
- Creates variety of card names, languages, sets, and prices
- Ensures reproducible test conditions
- Scales from small to large datasets efficiently

## Assertions and Thresholds

The tests include several performance assertions:
- Individual searches should complete within 100-200ms
- Performance scaling should be roughly linear (not exponential)
- Non-existent card searches should be fast (< 50ms)
- Memory usage should scale predictably with inventory size

## Interpreting Results

- **Execution Time**: Lower is better, measured in milliseconds
- **Matches Found**: Should be consistent for the same search across different inventory sizes
- **Performance Scaling**: Time increase should be proportional to inventory size increase
- **Memory Usage**: Should grow linearly with inventory size

## Future Enhancements

Potential areas for additional performance testing:
- Testing with real-world data patterns
- Concurrent/parallel search testing
- Memory leak detection over many iterations
- Performance profiling with different sorting preferences
- Testing with very large inventories (100k+ cards)